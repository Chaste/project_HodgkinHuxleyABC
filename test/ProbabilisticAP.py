''' 
	Written by Aidan Daly, DPhil candidate, University of Oxford Department of Computer Science
	
	Part of a paper tutorial on ABC parameter estimation for the Hodgkin-Huxley 
	action potential model.
'''
try:
    import unittest2 as unittest
except ImportError:
    import unittest

import fc
import fc.utility.test_support as TestSupport
import fc.simulations.model as Model
from fc.simulations.solvers import CvodeSolver
from fc.language import values as Val

# For plotting probabilistic traces
import matplotlib
import matplotlib.pyplot as plt

import numpy as np

''' 
	Subjects Hodgkin-Huxley model, parameterized over all particles in the posterior estimates
	below, to the protocols described in figures 20-23 of the 1952 publication.
'''

# Sample final posterior estimating populations prodced by HodgkinHuxleyFittingABC.py
potassium_post = [[0.014935367515946957, 50.912780333796086, 28.586812650455084, 0.1315337641788824, 87.18065141278687], [0.01665026957344564, 55.676783387182795, 26.051684732662014, 0.13083971747440484, 60.45627121411585], [0.014768751540512624, 52.42613619559161, 27.45201072916, 0.11737698843347501, 92.94354294554184], [0.011701585910988722, 31.256390357159745, 29.87234354481363, 0.19004586747749028, 73.20029530676177], [0.012785349165673887, 50.2394486019796, 27.57991945142513, 0.09956242253058392, 85.35223547576186], [0.01651620777364135, 57.133105132321475, 27.276262251389646, 0.14789487494638592, 88.12755328390386], [0.012013522453037542, 33.21572275852527, 24.08377934673665, 0.12830155664209297, 95.15889676970407], [0.016776952591490375, 56.2210382966276, 26.466083961830833, 0.1103176297960789, 88.65037635789757], [0.011187305832132819, 52.8145104137229, 41.08629560390537, 0.2767519853840993, 44.60712363633596], [0.014183047569270312, 54.37501513769046, 30.417141877085832, 0.11653893441478491, 83.18640917147904], [0.014242875224266954, 55.17367675291517, 28.234648736708337, 0.13110581913918637, 86.8043743302973], [0.00884668629034996, 19.08197612279548, 36.00097207825551, 0.3079474607177182, 43.709445553307084], [0.013381338025124085, 54.17479540359879, 33.07905500634676, 0.16548524508407164, 58.90826353994151], [0.01208795848947077, 43.89916254683319, 25.31649281779523, 0.1011193960628802, 99.04452995952808], [0.016356990543971037, 56.552567510884074, 26.904242548607538, 0.10835938530328418, 86.39098364260838], [0.013374369069638853, 56.95841516376559, 37.91774350042519, 0.1794712017352605, 68.23336668609328], [0.01281940283226951, 41.02050660243785, 27.042469127220826, 0.16303550619023652, 59.962573579913816], [0.01355497752249881, 64.61079693439335, 42.90567827976983, 0.2528305607668873, 49.927648745452025], [0.018009139600984606, 56.170472920631525, 25.353518483401434, 0.11805154356452202, 93.01766243431744], [0.012837703392768551, 50.38268144281528, 25.18698139693012, 0.08419468020906569, 90.72538948230111], [0.014820157012056343, 46.59101409251234, 29.572931175560576, 0.1738471900880238, 70.05811086044929], [0.014569278711387313, 49.957415331683805, 29.867035302879113, 0.14730380918611144, 87.05360881645251], [0.013572261550015601, 35.59828352175255, 18.27700375864931, 0.08920843558762792, 92.2831912979437], [0.011984962944352764, 46.75916873548466, 31.071806056917946, 0.13915482614231195, 67.78499130441033], [0.014373584588325106, 53.423299111224935, 30.5816636245474, 0.13917193792705213, 93.14041897329592], [0.012259025930597325, 30.378763876572663, 21.73028426302649, 0.17428014106609568, 70.64219192130307], [0.01238622851441352, 27.75548455870668, 20.890050235936677, 0.1445430577965083, 95.09539733139476], [0.016686602982380956, 48.202190776372596, 25.59029988967606, 0.14786866132803175, 90.31221043730459], [0.016284927277404746, 53.99191273047255, 25.432828410356073, 0.11106072659397118, 87.99750308196423], [0.017699377691851217, 63.99907834738399, 26.77603510863458, 0.12213114544126327, 71.44101771757148], [0.01550253818365617, 44.8937717964007, 26.247407538057107, 0.1712818804399312, 67.25417483582065], [0.010309175157319724, 30.321825790261734, 29.052456408504245, 0.13386062903255258, 71.38791902010706], [0.01582313966963336, 59.29255547910402, 30.144806831781754, 0.18662884974314858, 66.28503936631392], [0.016913433017466832, 54.295668820223085, 24.261455666463352, 0.14064193238186995, 84.38373698723666], [0.013276334013008345, 51.66012663895522, 28.058534833248686, 0.12061091504498564, 57.80149740507276], [0.014998688183974278, 56.19849216520795, 28.539199153541016, 0.12941693404599386, 84.12494668684111], [0.013803287968061951, 53.199444763111906, 34.980046606450856, 0.1891745027832081, 62.39963070864229], [0.014707661139040677, 52.78840180836219, 30.32557614230588, 0.1426608112498675, 85.1606906565527], [0.012727000070306775, 54.63093929097077, 33.50576209041482, 0.18388249690705918, 55.262869466868146], [0.015662842199585126, 47.99008463346486, 25.848002835545618, 0.16182151066534275, 83.41098208616961], [0.0147698751476702, 49.3129669175037, 30.8501161809456, 0.15962852814799589, 89.52318107956495], [0.013435135357411126, 52.80564351903911, 30.1974163356023, 0.10866877338262544, 91.77219276104753], [0.013424251084383165, 56.805431928986636, 32.31684214606639, 0.21393517922404084, 46.459059403686936], [0.01332138363765452, 63.17801851976387, 35.56048264606106, 0.1676192610131224, 49.42927464505616], [0.016805389437319768, 52.52394334054279, 27.40170749078809, 0.15055994555913488, 86.73138342905918], [0.01504680397271209, 55.793341997939294, 29.576536082401834, 0.1351291439454535, 87.47589249639309], [0.01518087579503573, 52.42860031068797, 28.78444837626863, 0.1361293613009642, 90.09702983028978], [0.01694533293505734, 53.67407386334915, 27.75162761078074, 0.14169791408321827, 90.13091480648133], [0.016733853376072635, 56.74342614716234, 24.851026819454933, 0.11732928193767482, 91.56711787281628], [0.017678713403622086, 49.48049557745495, 22.537593990493143, 0.11158118410690189, 87.6863563376345], [0.013090969417370877, 33.43145199197763, 18.260918324788125, 0.10379774749842657, 71.81921533137904], [0.011148769450438719, 29.79344280553252, 24.50206016071079, 0.18957079829288262, 50.88399718821198], [0.014013773415112712, 49.79687361491663, 29.835481316828073, 0.15816276297503792, 56.464254702856145], [0.017153242728748897, 53.58960143726682, 26.904042027656683, 0.1601688382232131, 69.92499540221847], [0.010345393681983242, 28.60322644918839, 26.70735686782902, 0.1272957141077688, 88.01708215717068], [0.009695247074679305, 22.90930361484654, 31.035962814013267, 0.2371106557840459, 50.24298331199088], [0.015051970620817244, 50.170435294104195, 23.66801771823212, 0.12513125165720287, 87.83515618868492], [0.011292334094950368, 30.37258257497823, 18.679998482621475, 0.08805091689489332, 95.91203207763623], [0.013932016464658267, 56.60557546270995, 36.60449526377988, 0.20156110695139848, 58.747973122912505], [0.014209673777531791, 36.94657747504604, 17.924217790933742, 0.10553784864110423, 98.16086275874791], [0.013649191768929474, 50.077446254172, 26.7665944101865, 0.12422681098903837, 92.10940847541445], [0.014240893935956981, 52.12332183613083, 27.23621403943782, 0.12093786144471602, 90.93128796093615], [0.014401927615304233, 34.95883317228539, 19.45405968760723, 0.10756235090674106, 93.03938893123309], [0.013654599967934765, 50.74195386497371, 26.843514426614018, 0.12303364674819069, 87.20550037831376], [0.01698146078556759, 49.09873058772017, 24.505893633281083, 0.14162059798183346, 90.93093044132684], [0.0105643452783965, 29.7645441872529, 19.19518297865559, 0.11573060159349187, 53.33184680396209], [0.014763937017225339, 55.49103134605131, 30.06543926881183, 0.15538158920895054, 80.40031608372357], [0.010040969928849218, 21.391240806896217, 27.432928409013563, 0.20191653470083423, 53.292906859522425], [0.01359590523175391, 52.37697583545055, 32.653397234367674, 0.15571733647895764, 86.1607610816764], [0.013674814966229328, 33.52443590148982, 23.954957326805452, 0.13857003826521497, 90.21640026257664], [0.013269373190768154, 40.21591302099749, 25.299230330447404, 0.17453583926268113, 63.53772174895999], [0.01815893211773834, 53.6815730827212, 24.269892114060674, 0.11403636098329129, 91.83105559600423], [0.015093757017821258, 51.07947179232845, 30.268557652990552, 0.14314609836745423, 91.61255184680482], [0.012152701542153957, 36.837033760920164, 30.09986489787312, 0.20335877365544655, 52.638321360322905], [0.011735944312753863, 40.93958945296768, 27.7011134857535, 0.17623286286582912, 51.71410667553212], [0.013046385538355756, 42.113020114865584, 29.488882170528058, 0.17823797740332292, 67.3835220537165], [0.012775986696403377, 49.500290066235976, 25.97189212169772, 0.08853137422635501, 88.41439832193889], [0.01423357772996298, 62.146537598656025, 33.29600774164013, 0.20938425315508255, 49.16237868284815], [0.010382005149808504, 27.61885890985088, 25.741367090675993, 0.1821039492810538, 58.67338928189897], [0.013069659411444166, 58.19393649959291, 33.68641005700083, 0.17868648895804395, 58.425880173432425], [0.011128466502768197, 38.096907468380735, 31.921586119433112, 0.19311388277623737, 50.863322083655], [0.013818999587760384, 46.716047613223914, 27.162322965882243, 0.12636037767116878, 64.58381251387935], [0.013873824131808904, 58.00836862397069, 29.76255956225348, 0.15753059600524136, 45.426679654143285], [0.014664224905125624, 48.05052221973592, 28.126697261883415, 0.15451466309285997, 64.70623532690496], [0.009480627628032156, 27.065497628809226, 26.74378403836097, 0.15984608758073882, 55.75723984941779], [0.012631378717719426, 62.43268191985838, 37.769489305932694, 0.19542782262161437, 49.132775483695774], [0.014492975465586597, 34.153738350700515, 21.220696556607987, 0.14109158971938104, 97.3866413487428], [0.012225848020816004, 32.78162496184693, 25.34265017384365, 0.1881748483641531, 51.047619224567946], [0.016930909027934475, 58.706687833861984, 27.22179395817295, 0.12616801078293277, 89.0828791280478], [0.015054723537329714, 56.21059519656728, 29.878270587351327, 0.19592397250829963, 46.22340297899919], [0.013626454266009842, 49.26685698250984, 27.650769067634766, 0.09976308381985544, 92.13753782664105], [0.00926623464944989, 26.667179229397455, 21.687094747878277, 0.09888470364921997, 66.37849864046561], [0.01418964355510512, 57.47589568374893, 37.38500659937607, 0.2669080780300981, 48.88321553005227], [0.011206515396770252, 32.618578848934916, 19.113747653783925, 0.07572514111238648, 93.57276094166357], [0.010274218446102044, 23.99032349515588, 30.10745440116004, 0.19165835363701014, 59.03973319523615], [0.01431173445261508, 31.704795639251074, 17.812588445699735, 0.12638246757071436, 81.27182029990338], [0.01146660557234878, 35.15125944719318, 35.26477002799601, 0.25351085174994936, 54.24846123455746], [0.013201771846364166, 29.081193509645267, 16.878028160416857, 0.09862341735729414, 91.67969499093502], [0.012777069219674732, 51.341692267952745, 34.55539847539407, 0.15423248163962244, 64.79479857362672], [0.018538650144677368, 52.11745336484641, 23.91826563433534, 0.13800438892552522, 89.20307432587276]]
sodium_post = [[0.11369302233995998, 15.882698671311777, 4.821929839218781, 2.3481263139612265, 95.67961799137738, 0.23534593262148776, 9.867275777715339, 38.90428659535874, 10.738039576171783], [0.1036302870888906, 13.07559231090235, 3.381625030185674, 2.4123139783811602, 95.16709470303172, 0.7711118187439902, 4.817779011777226, 38.525023791742775, 13.654732900128602], [0.11173210690240595, 13.81948686551643, 4.177837088989076, 2.3271313220661747, 97.24296597589783, 0.43027224429884486, 7.950929846638274, 38.3797227911277, 12.812089676055152], [0.10783929349028518, 11.82949250883588, 1.3329476223441543, 2.8919645815770636, 95.73343445681682, 0.8339605416077241, 1.770880001855712, 45.59411278776611, 14.753831133772355], [0.11784362291052916, 11.388602489184532, 2.4912938953023356, 3.2086294136037834, 93.57179073685681, 0.00880728291851423, 4.8967964458156645, 43.48574434341301, 12.944699009865673], [0.10093185091436822, 13.711716686255423, 3.196672446654505, 2.2720287826973173, 99.69425007117067, 0.1746975010041481, 1.0359025351133464, 41.05349194966969, 12.296808261117658], [0.11304580005808938, 13.046590701163018, 4.432728107579087, 2.6698117080268693, 98.65965717564383, 0.46657222948579674, 10.497324140262396, 37.29281773158356, 15.666375619725168], [0.10839595678641273, 14.443564863959391, 2.9702329364614384, 2.2790430995147783, 90.604284309399, 0.05579486426960867, 3.6469028699096095, 37.650590800321595, 12.14520420020887], [0.12399990978498025, 15.250217983950945, 5.368118850331234, 2.9804878708018316, 99.25334836663856, 0.5579838840684382, 5.042734136359726, 41.82522879451083, 12.248817009104396], [0.11265531821936822, 14.584221715707606, 4.1298951504579025, 2.4974311317734172, 92.961472069784, 0.025661291378462625, 1.7567399555027923, 38.6607080476477, 10.613762432446936], [0.10282081782907704, 13.961772906404892, 4.343692284106408, 2.0675561030187097, 97.81995412898989, 0.17763955590590852, 9.615288348614946, 34.10880225809934, 15.331119468197192], [0.12152928808072018, 14.725693146955777, 3.6109128743788306, 2.7750627252471802, 99.04509534366893, 0.5991494585263155, 4.569383255000282, 40.99687630225404, 12.697905093673079], [0.1170949673783994, 12.336297121546316, 4.107895437211475, 2.8615496558387847, 99.51376257602564, 0.32885168190436576, 8.917667284599723, 38.12652212695643, 12.984614503725412], [0.10745822349460835, 11.543781151955669, 3.4096742833188958, 2.7993021369929316, 94.30181913050937, 0.45860748095111237, 6.818712974034589, 42.92927577908389, 13.063525721437655], [0.11522498723724865, 14.708506249419436, 3.322951586220364, 2.392495197086247, 96.23716808039833, 0.12207864286639211, 1.0781607084218272, 41.78476660090208, 11.740564740282627], [0.11131342790051181, 13.426314474952923, 2.2399064970985556, 2.5727586514470446, 93.05095875471092, 0.30553291564870744, 7.770385389589626, 39.835523669840605, 12.423915076335568], [0.10963902619307789, 15.486708096702275, 4.185822232151322, 2.284697156774258, 97.40636652585084, 0.33787212508844333, 4.42963064225607, 40.160311092279244, 13.715702905845532], [0.10784986694964231, 13.234453124269894, 5.643804867074634, 2.4691354618498673, 94.9970393264467, 0.031524183845809906, 8.159321011300165, 38.670415802230195, 14.437716530798474], [0.10862767583146662, 14.880170382566162, 5.0027175842710285, 2.3177995637423923, 96.27521269440768, 0.751170961821444, 5.5079457903388676, 40.66780974091945, 12.15271553100666], [0.10247551766368385, 14.059608557264797, 4.419809314304598, 2.158916007535943, 98.63717414787246, 0.1492146544889664, 12.559081247177101, 37.455233799328305, 16.529979497711366], [0.10164823168802556, 12.306306192803614, 3.322994746572044, 2.4117612371718535, 95.00143755151315, 0.24840981153387082, 9.93170997059377, 41.66319659204116, 13.042476151728161], [0.11911087783278339, 17.629705899254457, 5.7244858033398165, 2.4601464720435917, 92.31950994723232, 0.16665210474722997, 4.565848976915157, 41.53988897581927, 12.529459459374761], [0.10218326613097477, 10.791407300190116, 3.07305096799199, 2.5681776445196203, 96.35698000288907, 0.07631260830936647, 12.830134476661028, 37.25207861906673, 16.72052489298159], [0.11995552658866851, 17.692367646808783, 4.549272777610503, 2.311526593179021, 99.13304315871186, 0.9914463759218961, 1.0033409637843431, 42.196281347985405, 10.423125905406874], [0.1019209672214121, 11.77870638812881, 2.5857099221444453, 2.2789572086869163, 96.04640787246471, 0.6119161292728579, 7.034606449998259, 37.4999663934261, 15.164083626126583], [0.11218547390285943, 11.611959728551653, 4.005092043312029, 2.9935743099683916, 91.57400193917466, 0.3615582236925366, 4.569924635372458, 41.74673314507402, 13.122826296159184], [0.1121481116037105, 16.425670165485116, 4.179798505800127, 2.232700905610006, 98.74332979583276, 0.9626073464038987, 3.956822935087726, 42.42319164250987, 12.859832782397524], [0.1066992000368533, 12.237192644661018, 2.9942080618730245, 2.368052186422342, 99.64933506330507, 0.2449701912179374, 7.1555241756862475, 41.17341815577912, 12.278597828217162], [0.10231067182934557, 12.573605967563894, 4.039209203354737, 2.1604709689264743, 91.93791682904482, 0.014322649243321807, 14.881296547827146, 35.76085762785469, 14.265449435772473], [0.11320118451829411, 12.417302967050755, 3.8029142431929204, 2.8670773772060514, 96.5566428310171, 0.8545537819923352, 1.3143261091846616, 44.5698605431896, 15.91329914575704], [0.10651230236995801, 11.21134178948369, 3.895619809739963, 3.0773677804647916, 94.57680326478291, 0.8394540674939502, 5.197801141032406, 45.941784982872555, 13.719933422610154], [0.11984948182893403, 14.50734522180448, 3.375734555281363, 2.561789785558728, 96.27191174125844, 0.07874181678647978, 15.832238020064263, 37.43648551200002, 11.576043157797491], [0.10963127796873515, 15.004212311083569, 3.609152024457967, 2.1500486294937318, 96.55238311733156, 0.20916708202619952, 5.0500671839468225, 39.29922286591049, 12.51954669177792], [0.11339867770579203, 11.391549123425103, 1.1387847013270251, 3.024835667375093, 95.66254746067735, 0.8035762687952273, 6.131817355756099, 41.71835799608618, 12.30303874609291], [0.11183642953285232, 12.77051228062882, 4.50600500365242, 3.06937917364358, 94.99477209583141, 0.3420352760056781, 4.958205568467001, 45.57056076932059, 13.557170027734193], [0.1150621562190371, 11.524277458040926, 3.1777050250639594, 3.0871580741597793, 97.04436137186633, 0.17032512330495836, 7.298001665566147, 45.86098464084085, 15.650757557755448], [0.10306005709521361, 10.741260197202237, 2.466596757268249, 2.6091149006840015, 94.2879005649406, 0.16288355697286125, 5.668302061471762, 40.90234673467232, 13.815436113990637], [0.1097012027740235, 11.863147910968788, 2.151448451745962, 2.974087653599177, 94.60883114860664, 0.2134246211731176, 5.783002094819256, 43.642446721749366, 13.641888380647787], [0.11501112782542994, 15.811607076924435, 4.560820000256692, 2.543098024178201, 99.91331173630384, 0.7217352311637866, 7.5780445636333145, 41.367115806603834, 14.24264761474068], [0.1082370180620686, 15.31395574849861, 5.657862000938592, 2.2366501137619936, 99.78988978942046, 0.08400140629791794, 3.9657108795033933, 39.28186552858019, 11.64574520279127], [0.11242749270801645, 15.354937810725827, 5.235821682490177, 2.282052572724671, 92.29966376398706, 0.21731124163630022, 2.9543362086318226, 39.91374509831628, 12.249016892688804], [0.12011808863792241, 16.066404709848936, 5.906242025122934, 2.692212666433962, 90.53103940164175, 0.8550422966452869, 1.278315864711758, 40.88328529395697, 11.794171142789486], [0.11313221578835934, 11.966120209789741, 2.448475080050154, 3.0047523218979943, 98.70876100708836, 0.8221292664366119, 7.3659730084580985, 41.95717410455737, 13.22567948207171], [0.10608005149387298, 14.032040522022557, 3.319198932370854, 2.3325532206481916, 96.71235072923629, 0.09978584602686924, 8.331888006447455, 42.58838037630768, 13.837578688963703], [0.11269330163183572, 11.385613814718855, 2.8378429562737466, 2.883330762870787, 96.16102107367428, 0.9476153611616757, 3.5463514050939455, 42.521048920872424, 13.088088771120708], [0.11034178134260109, 11.985445622356494, 4.274190699314396, 2.631073470134897, 97.64999055139045, 0.34003764082391663, 2.12918511223696, 39.21814884035289, 16.633840575387715], [0.10983484734222532, 13.174097417218988, 1.577902162917561, 2.375700272517208, 97.67148546070857, 0.5240802602194576, 1.0595183008642306, 37.68382940735012, 11.322279046213463], [0.10428598440211916, 10.934454005884707, 4.84388055102668, 2.711534718433254, 99.61915010210618, 0.18617884897609777, 4.263078479709837, 43.48497059024566, 13.695954747424175], [0.10738852154216269, 13.461405135470917, 4.1201563611797205, 2.5892458862388743, 92.58456209165753, 0.19824502492052906, 4.153374891985257, 40.487593798654686, 14.930639092583153], [0.11428344451099146, 14.008872496420429, 1.662952698538644, 2.72023968578166, 97.27882357669769, 0.8761220806445945, 6.658268892374605, 41.660027921394686, 11.951456122944514], [0.11066887096883149, 13.608711767636269, 2.1320904315697504, 2.6746847084121073, 93.52666011436963, 0.5426445508076068, 3.7469527034951406, 43.92719762831697, 13.537154123723615], [0.10360235970851228, 12.403712554808711, 2.7208751344235313, 2.528967307505011, 97.05926986318087, 0.6393635059188836, 5.494197580327571, 41.94486120492067, 15.864618315713582], [0.10609485566685888, 12.02174721503816, 2.6806469258923893, 2.4048164668338003, 98.2378988460756, 0.953147529291839, 2.272162198730963, 35.67777329401146, 15.87487327371477], [0.11501643642701706, 11.732515167599335, 4.372736186696346, 2.9912642269277496, 98.11209138107345, 0.6782163618209729, 1.113999046159467, 44.81680932004808, 14.527408614964875], [0.11231052824698769, 13.813517733903218, 5.0678239695328315, 2.500438934884745, 95.55156826787764, 0.17776762044882224, 7.361773296712234, 40.07380530094732, 14.049055029071459], [0.10816322083094701, 12.783812484118679, 2.1392080116245316, 2.724477377679848, 87.9622286534575, 0.22809629887727026, 2.908573895277935, 42.055326631595676, 11.878978769830859], [0.108047028103389, 12.958976035135045, 3.8901884386174426, 2.476188915644157, 95.19785193129296, 0.1403022113725759, 18.914736428561884, 38.9007371042883, 13.514908218514993], [0.1213956906943568, 16.057761098616872, 5.660768629589296, 2.7254595966987707, 98.83069224356201, 0.07175943682858135, 7.968790909342445, 43.488272110651195, 13.649255253858302], [0.10099710074781085, 12.179653724201671, 4.342783752143287, 2.1966226677391387, 99.81717955057626, 0.2089663231198359, 4.463594468362994, 36.81283329042801, 16.689194989598903], [0.10802989615909728, 12.144066040927022, 4.076755453793306, 2.727137001456626, 97.82707485194337, 0.2766822510806303, 4.500623118731442, 42.42760489505215, 17.005818239451624], [0.1028186898527127, 11.927279373581339, 2.557474892607324, 2.5593166872414237, 94.80877189782348, 0.5294902511106125, 1.5301355554096938, 39.10681788773689, 13.955248983451575], [0.11681224446299396, 13.636031480919545, 3.8906918247807667, 2.637206381557886, 91.73512591178448, 0.648858122623414, 3.8017518667718826, 39.276370438168556, 11.46453227997517], [0.10476294585136316, 11.221445136665368, 1.6765306137567042, 2.648393977869794, 98.1369133856753, 0.10210693846894492, 1.0467231902681762, 42.663568703646575, 16.550646523809355], [0.11022707125028333, 11.626260743681197, 1.4563425332896647, 2.849599421970928, 93.34030961014717, 0.4082677762533728, 6.5806378964033705, 42.148816821183914, 12.987793390679347], [0.10604733582189756, 13.821305166696966, 5.848703599966987, 2.5777225776459374, 93.70995850353717, 0.2629302229230855, 4.468316312420379, 42.105485704668396, 14.93190750771796], [0.11068825677741959, 11.699714428898911, 1.9421940443391421, 2.872683410715733, 97.55482909783291, 0.6606710838756117, 5.173140883763908, 39.63423571672761, 13.179208750727907], [0.11283274078485357, 10.867647465406256, 3.2836768398747864, 3.23795694995982, 98.69440990211395, 0.34953918182558125, 5.783703895544171, 45.95334927467361, 15.745511026840209], [0.11034108470742243, 11.24407643656246, 4.480348192021383, 2.974393484033925, 92.29239871226704, 0.7118437982731547, 3.6141569495003916, 43.0846393586365, 13.719672485472259], [0.1057624277885209, 11.582472393055282, 4.122559963916668, 2.6685044247668466, 97.66456524070348, 0.6162857812877167, 7.009964490313951, 40.04773170226857, 14.19976121498334], [0.10260469245097614, 11.507962581361067, 4.163921321623664, 2.2850956412343235, 97.1604749744109, 0.12985054434288001, 5.321825518413048, 37.80640764524223, 15.064337294108293], [0.11466822123933666, 14.231374478386327, 2.4787968588261355, 2.522190133288405, 98.94987929683604, 0.34661665682951764, 5.4766772459940505, 43.45119462842112, 13.952069538872177], [0.10585642666808366, 10.350805540416994, 1.8483455740104504, 2.6429799702726786, 98.88928168456215, 0.0003892344915429266, 13.023536777998597, 38.531850340117714, 16.538770080334412], [0.11295663133253986, 13.468598087910753, 4.539427541545855, 2.3503249136640947, 98.59530347323906, 0.3823480566814009, 1.0737931035556503, 36.20982682760396, 13.085973196968196], [0.10879132220854527, 14.408880999516999, 3.9179212175453784, 2.6218688628564197, 95.87550075362556, 0.6090464722355157, 6.8473229145335335, 44.28792416571447, 12.60898167544281], [0.11427039661996446, 17.058188877233974, 5.1812208299991145, 2.2470858145703305, 98.47160488046934, 0.016933419642858907, 17.555362200611178, 41.20995217089348, 10.602643112880331], [0.1076331923566819, 14.802080828232658, 3.6282128185522637, 2.1927929625302602, 98.93388092949604, 0.3446892338216273, 4.9985611376601575, 41.821395483747125, 14.834237152598451], [0.10807625443240668, 12.440408107319607, 5.18849875363253, 2.580054831456947, 97.86175537509432, 0.15883046542966217, 7.055693347711156, 38.70747879415481, 16.840890575640557], [0.10510240613364087, 10.200316003523422, 3.0725756267348694, 2.9994529003262795, 91.79235048272595, 0.7951904745389756, 4.832831208820073, 43.46990421376812, 14.634793046745632], [0.10937974601123045, 14.642136594153591, 3.8605944514018455, 2.6090583797841203, 96.47879107933308, 0.0786561468919188, 6.8870851257373, 45.413445669362126, 11.563104067753509], [0.10176029617153237, 11.049780755889893, 1.921407179882502, 2.4880337624936306, 95.82576244624805, 0.5215329633855286, 3.591277548490105, 40.03647062002122, 11.836625448030892], [0.12088576112976909, 13.506371972187504, 2.893739376186299, 3.122628564114777, 98.27674483899199, 0.5384077667773061, 1.9396139255822717, 44.53287047191877, 12.398818690411986], [0.1181275051763596, 13.587317258322027, 4.937612433446839, 2.857821784207882, 98.8679336229904, 0.3530881353035836, 3.9852312275449417, 43.97886106871175, 13.857995131510428], [0.1102680987698305, 13.17915491046174, 3.377870009547782, 2.804243655723134, 96.92546616043197, 0.7791282420089458, 1.4108241852238521, 43.567678795177315, 14.625672642887583], [0.12724098730133082, 14.032436460437344, 4.678189429656858, 3.400934250900426, 97.09691549261935, 0.553082531333897, 2.9964499192884047, 46.80665447581285, 13.685494401106032], [0.10317954099281051, 14.241803922763618, 3.8842565012624664, 2.1723332918487643, 88.88452632414226, 0.055576685409568234, 9.436694123202024, 38.22706962602393, 12.077779846528916], [0.1069059947223921, 14.31769791935189, 3.9729642225156763, 2.3107442264099713, 98.54839189140257, 0.658104660006305, 1.6368016888023726, 37.22124331584042, 13.367380892734237], [0.10081476626701011, 13.632106329119718, 4.284688077644675, 2.1522616242316146, 96.75848367495585, 0.5182784317121261, 1.420993245095251, 38.05558846658372, 11.533286481106042], [0.11240761015078285, 12.367825990870209, 3.2371035591920094, 2.768098255350359, 97.48014962891334, 0.6997721122183724, 4.54678445466677, 38.99017002335152, 11.948129216211003], [0.11713388668257622, 15.50226094505261, 4.999986732475943, 2.6180600986823417, 97.01945952977051, 0.24388255435689898, 1.9938082769290995, 40.4362756648018, 11.677848141801089], [0.1127443856009516, 15.300153771713514, 5.3565223140169245, 2.714602308062782, 98.50975358241743, 0.34612949540187377, 4.061013078129353, 44.0215989696418, 12.972563916652154], [0.0986463086529715, 11.314150146526629, 3.19172319399252, 2.2848144434216793, 93.83430023836216, 0.2454597519467961, 8.984283278084044, 36.17045368600698, 14.854743916418165], [0.11426694443271108, 12.589670110418488, 4.9066857592440485, 2.7379109934503574, 95.41848615232811, 0.2705309502674487, 5.300076075096225, 37.51709550416631, 13.444479143165601], [0.11231078399039872, 10.108406904077258, 3.9973440599435675, 3.2584411897608017, 99.22590102183956, 0.43903515916922453, 6.906141462144973, 43.4346777699911, 15.094833717155673], [0.10679781245402915, 12.365629473827996, 2.5085468953665164, 2.58475722419172, 97.5800744966636, 0.36687190711795176, 8.986837802040611, 38.24942010754942, 13.291212463909334], [0.12471121309903924, 13.839973670756732, 3.363024606978467, 3.0191595156135547, 97.54931539465015, 0.9165716085974147, 4.798132308844334, 41.80119890302847, 13.136434575571347], [0.10669517727699517, 11.829931071151815, 4.935006787580582, 2.7578441201010038, 91.1130250297456, 0.47188401671205055, 2.8205101840546036, 43.63408347083337, 13.666239557825696], [0.11129286202174148, 12.773213094652789, 2.0153999716768585, 2.7609144405862174, 88.28267258790149, 0.8651816126740197, 3.155762493267549, 42.480313474184406, 12.414660037573194], [0.10792380551629295, 11.709287210691212, 3.883670300420193, 2.8192895592611915, 94.60642953930622, 0.14610199958097106, 6.925807786197167, 39.46885367752431, 16.446137351362566], [0.11257824377208357, 13.856798669885132, 3.4037519856236504, 2.4529268390787373, 98.98733507445645, 0.35257875868943067, 6.829227399822902, 40.95100970634071, 14.92888328819712], [0.10457983575624336, 10.685781272261034, 4.036669466153274, 2.733970632105365, 96.67359271595338, 0.27918147214516076, 1.4997148783631586, 43.2294325466167, 12.988757347248221]]

# Switch variables to control whether sodium and/or potassium conductance parameters
#	should be set according to the above posterior distributions in PlotPosterior()
samplePotassium = True
sampleSodium = False

class TestProbAPProto(unittest.TestCase):

	# Positive phase depolarization at several time points during AP restitution
    def TestPPD(self):
        proto = fc.Protocol('projects/HodgkinHuxleyABC/test/protocols/OscillationInduction.txt')
        proto.SetOutputFolder('HH_OscillationInduction')
        proto.SetModel('projects/HodgkinHuxleyABC/hodgkin_huxley.cellml', useNumba=False)
        proto.model.SetSolver(CvodeSolver())
        proto.Run()

        # Original Hodgkin-Huxley trace
        V = proto.outputEnv.LookUp("V").array
        time = proto.outputEnv.LookUp("time").array

        # Set up figure
        font = {'family' : 'normal', 'size' : 18}
        matplotlib.rc('font', **font)
        fig = plt.figure()
        ax = fig.add_subplot(111)
        ax.set_xlabel("Time (msec)")
        ax.set_ylabel("Membrane voltage (mV)")

        # Do other protocol runs and calls to plot()
        self.PlotPosterior(proto,time)

        # Plot original trace last to overlay on predicted traces
        orig, = plt.plot(time,V)
        ax.set_ylim(-86,-70)
        fig.legend([orig],['Default parameters'],loc="upper right",bbox_to_anchor=(0.9,0.9),prop={'size':16})

        fig.savefig("OscillationInductionNeg.png",dpi=400)

    # Membrane voltage traces following depolarizations to potentials below excitation threshold
    def TestThresh(self):
    	proto = fc.Protocol('projects/HodgkinHuxleyABC/test/protocols/ThresholdExcitation.txt')
        proto.SetOutputFolder('HH_SubThreshAP')
        proto.SetModel('projects/HodgkinHuxleyABC/hodgkin_huxley.cellml', useNumba=False)
        proto.model.SetSolver(CvodeSolver())
        proto.Run()

        # Original Hodgkin-Huxley trace
        V = proto.outputEnv.LookUp("V").array
        time = proto.outputEnv.LookUp("time").array

        # Set up figure
        font = {'family' : 'normal', 'size' : 18}
        matplotlib.rc('font', **font)
        fig = plt.figure()
        ax = fig.add_subplot(111)
        #ax.set_xlabel("Time (msec)")
        ax.set_ylabel("Membrane voltage (mV)")

        # Do other protocol runs and calls to plot()
        self.PlotPosterior(proto,time)

        # Plot original trace last to overlay on predicted traces
        orig, = plt.plot(time,V)
        fig.legend([orig],['Default parameters'],loc="upper right",bbox_to_anchor=(0.9,0.9),prop={'size':16})

        fig.savefig("MembraneDepol2mV.png",dpi=400)

	# Membrane voltage traces following prolonged membrane hyperpolarization
	def TestAnodeBreak(self):
		proto = fc.Protocol('projects/HodgkinHuxleyABC/test/protocols/AnodeBreakExcitation.txt')
		proto.SetOutputFolder('HH_AnodeBreakAP')
		proto.SetModel('projects/HodgkinHuxleyABC/hodgkin_huxley.cellml', useNumba=False)
		proto.model.SetSolver(CvodeSolver())
		proto.Run()

		# Original Hodgkin-Huxley trace
		V = proto.outputEnv.LookUp("V").array
		time = proto.outputEnv.LookUp("post_time").array

		# Set up figure
		font = {'family' : 'normal', 'size' : 18}
		matplotlib.rc('font', **font)
		fig = plt.figure()
		ax = fig.add_subplot(111)
		ax.set_xlabel("Time (msec)")
		ax.set_ylabel("Membrane voltage (mV)")

		# Do other protocol runs and calls to plot()
		self.PlotPosterior(proto,time)

    	# Plot original trace last to overlay on predicted traces
    	orig, = plt.plot(time,V)
    	fig.legend([orig],['Default parameters'],loc="upper right",bbox_to_anchor=(0.9,0.9),prop={'size':16})

    	fig.savefig("AnodeBreak.png",dpi=400)
    
    # Membrane voltage traces following membrane current clamp and release
	def TestOscillation(self):
		proto = fc.Protocol('projects/HodgkinHuxleyABC/test/protocols/OscillationInduction.txt')
		proto.SetOutputFolder('HH_Oscillation')
		proto.SetModel('projects/HodgkinHuxleyABC/hodgkin_huxley.cellml', useNumba=False)
		proto.model.SetSolver(CvodeSolver())
		proto.Run()

        # Original Hodgkin-Huxley trace
        V = proto.outputEnv.LookUp("V").array
        time = proto.outputEnv.LookUp("time").array

        # Set up figure
        fig = plt.figure()
        ax = fig.add_subplot(111)
        ax.set_xlabel("Time (msec)")
        ax.set_ylabel("Membrane voltage (mV)")

        # Do other protocol runs and calls to plot()
        self.PlotPosterior(proto,time)

    	# Plot original trace last to overlay on predicted traces
    	orig, = plt.plot(time,V)
    	fig.legend([orig],['Default parameters'],loc="upper right",bbox_to_anchor=(0.9,0.9))

    	fig.savefig("OscillationInductionNeg.png",dpi=400)

    '''
    	Helper function for above plotting functions
    	Simulates Hodgkin-Huxley model under all particle parameterizations in the indicated
    		posterior and plots resulting voltage traces against time.
    '''
    def PlotPosterior(self,proto,time):
		for i in range(len(potassium_post)):
			proto.model.ResetState()
			
			if samplePotassium:
				proto.SetInput('ank1',Val.Simple(potassium_post[i][0]))
				proto.SetInput('ank2',Val.Simple(potassium_post[i][1]))
				proto.SetInput('ank3',Val.Simple(potassium_post[i][2]))
				proto.SetInput('bnk1',Val.Simple(potassium_post[i][3]))
				proto.SetInput('bnk2',Val.Simple(potassium_post[i][4]))
			
			if sampleSodium:
				proto.SetInput('amk1',Val.Simple(sodium_post[i][0]))
				proto.SetInput('amk2',Val.Simple(sodium_post[i][1]))
				proto.SetInput('amk3',Val.Simple(sodium_post[i][2]))
				proto.SetInput('bmk1',Val.Simple(sodium_post[i][3]))
				proto.SetInput('bmk2',Val.Simple(sodium_post[i][4]))
				proto.SetInput('ahk1',Val.Simple(sodium_post[i][5]))
				proto.SetInput('ahk2',Val.Simple(sodium_post[i][6]))
				proto.SetInput('bhk1',Val.Simple(sodium_post[i][7]))
				proto.SetInput('bhk2',Val.Simple(sodium_post[i][8]))
			
			proto.Run()

			V2 = proto.outputEnv.LookUp("V").array
			plt.plot(time,V2,"--r")    
